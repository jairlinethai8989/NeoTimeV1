<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบเช็คชื่อพนักงาน - Time Attendance</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- Mobile Toggle -->
  <button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="fa-solid fa-bars"></i>
  </button>

  <!-- ═══ SIDEBAR ═══ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo"><i class="fa-solid fa-mountain-sun"></i></div>
      <div class="title">
        <h2>ระบบเข้า ออกงาน</h2>
        <p>TIME ATTENDANCE</p>
      </div>
    </div>

    <nav class="sidebar-nav">
      <!-- Main links -->
      <a class="nav-item active" data-page="dashboard" onclick="navigateTo('dashboard', this)">
        <div class="nav-item-content"><i class="fa-solid fa-house"></i> <span>Dashboard</span></div>
      </a>

      <a class="nav-item" data-page="checkin" onclick="navigateTo('checkin', this)">
        <div class="nav-item-content"><i class="fa-solid fa-location-dot"></i> <span>เช็คอิน/เช็คเอาท์</span></div>
      </a>

      <a class="nav-item" data-page="records" onclick="navigateTo('records', this)">
        <div class="nav-item-content"><i class="fa-solid fa-list-check"></i> <span>บันทึกการเข้างาน</span></div>
      </a>

      <a class="nav-item" data-page="map" onclick="navigateTo('map', this)">
        <div class="nav-item-content"><i class="fa-solid fa-map"></i> <span>แผนที่</span></div>
      </a>

      <a class="nav-item" data-page="shifts" onclick="navigateTo('shifts', this)">
        <div class="nav-item-content"><i class="fa-solid fa-calendar-days"></i> <span>ตารางกะงาน</span></div>
      </a>

      <!-- Groups / Dropdowns -->
      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-solid fa-envelope-open-text"></i> <span>คำขอของฉัน</span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="my-requests" onclick="navigateTo('my-requests', this, true)">รายการคำขอ</a>
        </div>
      </div>

      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-regular fa-circle-check"></i> <span>อนุมัติ</span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="approve-requests"
            onclick="navigateTo('approve-requests', this, true)">อนุมัติคำขอ</a>
          <a class="nav-child" data-page="approve-leave"
            onclick="navigateTo('approve-leave', this, true)">อนุมัติการลา</a>
        </div>
      </div>

      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-regular fa-file-lines"></i> <span>รายงาน</span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="report-general"
            onclick="navigateTo('report-general', this, true)">รายงานทั่วไป</a>
          <a class="nav-child" data-page="report-leave" onclick="navigateTo('report-leave', this, true)">รายงานการลา</a>
          <a class="nav-child" data-page="audit-log" onclick="navigateTo('audit-log', this, true)">Audit Log</a>
        </div>
      </div>

      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-solid fa-gear"></i> <span>จัดการระบบ</span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="users" onclick="navigateTo('users', this, true)">จัดการผู้ใช้</a>
          <a class="nav-child" data-page="workplaces" onclick="navigateTo('workplaces', this, true)">จัดการหน้างาน</a>
          <a class="nav-child" data-page="auto-escalation"
            onclick="navigateTo('auto-escalation', this, true)">Auto-Escalation</a>
          <a class="nav-child" data-page="settings" onclick="navigateTo('settings', this, true)">ตั้งค่าระบบ</a>
        </div>
      </div>

      <a class="nav-item" data-page="profile" onclick="navigateTo('profile', this)">
        <div class="nav-item-content"><i class="fa-regular fa-user"></i> <span>โปรไฟล์</span></div>
      </a>
    </nav>

    <div class="sidebar-footer">
      <a class="nav-item btn-logout" onclick="logout()">
        <div class="nav-item-content"><i class="fa-solid fa-right-from-bracket"></i> <span>ออกจากระบบ</span></div>
      </a>
    </div>
  </aside>

  <!-- ═══ MAIN CONTENT ═══ -->
  <main class="main-wrapper">
    <!-- Top Header -->
    <header class="top-header">
      <div class="header-title">
        <h1 id="page-title">Dashboard</h1>
        <p id="header-date">วันเสาร์ที่ 21 กุมภาพันธ์ 2569</p>
      </div>

      <div class="header-actions">
        <div class="status-indicator hide-mobile">
          <div class="status-dot"></div> <span style="color:#10b981">ออนไลน์</span>
        </div>

        <button class="icon-btn hide-mobile" onclick="refreshPageData()" title="รีเฟรช">
          <i class="fa-solid fa-arrows-rotate"></i>
        </button>

        <div class="header-user">
          <div class="header-user-info hide-mobile">
            <h4 id="user-display-name">HR Administrator</h4>
            <p id="user-display-role">HR Admin</p>
          </div>
          <div class="user-avatar">
            <img src="https://ui-avatars.com/api/?name=HR+Admin&background=2563eb&color=fff" alt="User"
              id="user-avatar-img">
          </div>
        </div>
      </div>
    </header>

    <!-- ═══════ PAGES CONTAINER ═══════ -->
    <div class="pages-container">

      <!-- Page: Dashboard -->
      <div class="page-content active" id="page-dashboard">
        <!-- Stat Cards -->
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-icon bg-primary-light text-primary"><i class="fa-solid fa-users"></i></div>
            <div class="stat-info">
              <h3>พนักงานทั้งหมด</h3>
              <div class="stat-val" id="dash-total">120</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-success-light text-success"><i class="fa-solid fa-user-check"></i></div>
            <div class="stat-info">
              <h3>มาทำงานวันนี้</h3>
              <div class="stat-val" id="dash-present">95</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-warning-light text-warning"><i class="fa-solid fa-clock"></i></div>
            <div class="stat-info">
              <h3>มาสาย</h3>
              <div class="stat-val" id="dash-late">12</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-danger-light text-danger"><i class="fa-solid fa-user-xmark"></i></div>
            <div class="stat-info">
              <h3>ขาดงาน</h3>
              <div class="stat-val" id="dash-absent">13</div>
            </div>
          </div>
        </div>

        <!-- Dashboard Charts and Activity -->
        <div class="dashboard-content">
          <div class="dashboard-card" style="flex:1;">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-chart-pie"></i> ภาพรวมการเข้างานวันนี้</h3>
            </div>
            <div class="card-body" style="display:flex; flex-direction:column; align-items:center;">
              <div class="donut-chart-container">
                <!-- CSS Donut Graph -->
                <div class="donut-chart">
                  <div class="donut-inner">
                    <span>79%</span>
                    <small>มาทำงาน</small>
                  </div>
                </div>
              </div>
              <div class="donut-legend">
                <div class="legend-item"><span class="dot success"></span> ตรงเวลา (83)</div>
                <div class="legend-item"><span class="dot warning"></span> สาย (12)</div>
                <div class="legend-item"><span class="dot danger"></span> ขาด (13)</div>
                <div class="legend-item"><span class="dot info"></span> ลา (12)</div>
              </div>
            </div>
          </div>

          <div class="dashboard-card" style="flex:1;">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-map-location-dot"></i> การกระจายตัวหน้างาน</h3>
            </div>
            <div class="card-body" style="padding:0;">
              <!-- Mock Map Report -->
              <div class="mock-map-report">
                <div class="map-overlay">
                  <h4><i class="fa-solid fa-building"></i> 5 สาขาปฏิบัติงาน</h4>
                  <p>มีพนักงานกระจายตัวอยู่ในพื้นที่ครบถ้วน</p>
                  <button class="btn btn-primary" onclick="navigateTo('map', null)"><i class="fa-solid fa-map"></i>
                    ดูแผนที่แบบเต็ม</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page: Check-in / Check-out -->
      <div class="page-content" id="page-checkin">
        <div class="checkin-container">
          <!-- Time Display -->
          <div class="checkin-time-display">
            <div class="time-label">เวลาปัจจุบัน</div>
            <div class="time-value" id="ci-clock">00:00</div>
            <div class="date-value" id="ci-date">วัน...</div>
          </div>

          <!-- Status Card -->
          <div class="checkin-status empty">
            <div class="status-icon"><i class="fa-solid fa-mug-hot"></i></div>
            <h3>ยังไม่ได้ลงเวลา</h3>
            <p>กรุณาเลือกหน้างานเพื่อเช็คอิน</p>
          </div>

          <!-- Location Info -->
          <div class="checkin-card">
            <h3 class="card-title"><i class="fa-solid fa-location-crosshairs"></i> ข้อมูลพิกัด & หน้างาน</h3>

            <div class="gps-status-box" id="ci-gps-box">
              <div class="gps-icon"><i class="fa-solid fa-spinner fa-spin"></i></div>
              <div class="gps-info">
                <h4>กำลังค้นหาตำแหน่ง...</h4>
                <p id="ci-coords">โปรดรอสักครู่</p>
              </div>
              <button class="icon-btn-small" onclick="initGeo()" title="รีเฟรชตำแหน่ง"><i
                  class="fa-solid fa-arrows-rotate"></i></button>
            </div>

            <div class="form-group" style="margin-top: 16px;">
              <label>เลือกหน้างาน / สาขา</label>
              <div class="select-wrapper">
                <i class="fa-regular fa-building select-icon"></i>
                <select class="form-control" id="ci-workplace">
                  <option value="">-- รอข้อมูลหน้างาน --</option>
                </select>
                <button class="icon-btn-small select-action"><i class="fa-solid fa-qrcode"></i></button>
              </div>
            </div>

            <div class="form-group" style="margin-top: 16px;">
              <label>หมายเหตุ</label>
              <textarea class="form-control" id="ci-note" rows="2" placeholder="ถ้ามี..."></textarea>
            </div>
          </div>

          <!-- Identity (Removed Camera) -->
          <div class="checkin-card">
            <h3 class="card-title"><i class="fa-regular fa-id-badge"></i> ยืนยันตัวตน</h3>
            <div class="info-row">
              <div class="info-label">พนักงาน</div>
              <div class="info-value"><strong id="ci-emp-name">กำลังโหลด...</strong> <span id="ci-emp-id"></span></div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="checkin-actions">
            <button class="btn btn-primary btn-checkin" id="btn-ci" onclick="submitCheckin('Check-in')">
              <i class="fa-solid fa-right-to-bracket"></i> เช็คอิน (เข้างาน)
            </button>
            <button class="btn btn-outline btn-checkout" id="btn-co" onclick="submitCheckin('Check-out')">
              <i class="fa-solid fa-right-from-bracket"></i> เช็คเอาท์ (ออกงาน)
            </button>
          </div>

        </div>
      </div>

      <!-- Page: Records -->
      <div class="page-content" id="page-records">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-list-check"></i> บันทึกการเข้างาน</h2>
          <button class="btn btn-outline" onclick="loadRecords()"><i class="fa-solid fa-arrows-rotate"></i>
            รีเฟรช</button>
        </div>

        <div class="card">
          <div class="table-toolbar">
            <div class="search-box">
              <i class="fa-solid fa-calendar-day"></i>
              <input type="date" id="records-date-filter" class="form-control" onchange="loadRecords()" />
            </div>
            <div class="search-box" style="margin-left: 12px;">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" id="records-search" class="form-control" placeholder="ค้นหาชื่อ, รหัส..."
                oninput="filterRecordsTable()" />
            </div>
          </div>

          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>วันที่-เวลา</th>
                  <th>พนักงาน</th>
                  <th>ประเภท</th>
                  <th>สถานะ</th>
                  <th>สาขา/พิกัด</th>
                  <th>ระยะห่าง</th>
                  <th>หมายเหตุ/รูปถ่าย</th>
                </tr>
              </thead>
              <tbody id="records-table-body">
                <tr>
                  <td colspan="7" style="text-align:center; padding: 20px;">
                    <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i> กำลังโหลดข้อมูล...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Map (wip) -->
      <div class="page-content" id="page-map">
        <div class="placeholder-box">
          <h2><i class="fa-solid fa-map"></i> แผนที่</h2>
          <p>This module will be built in the next phases.</p>
        </div>
      </div>

      <!-- Page: Shifts -->
      <div class="page-content" id="page-shifts">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-calendar-days"></i> ตารางกะงาน</h2>
          <button class="btn btn-outline" onclick="openSwapRequestsModal()">
            <i class="fa-solid fa-bell"></i> คำขอแลกกะ <span id="swap-req-badge" class="badge badge-danger"
              style="display:none; padding: 2px 6px; font-size: 10px;">0</span>
          </button>
        </div>

        <div class="card p-0" style="overflow: hidden;">
          <div class="calendar-toolbar"
            style="display:flex; justify-content:space-between; align-items:center; padding: 16px; border-bottom: 1px solid var(--border);">
            <button class="btn-icon" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
            <h3 id="current-month-year" style="margin:0; font-size:16px;">-</h3>
            <button class="btn-icon" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
          </div>
          <div class="calendar-weekdays"
            style="display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; padding: 8px 0; background: var(--bg-body); font-size: 12px; font-weight: bold; color: var(--text-muted);">
            <div>อา</div>
            <div>จ</div>
            <div>อ</div>
            <div>พ</div>
            <div>พฤ</div>
            <div>ศ</div>
            <div>ส</div>
          </div>
          <div id="calendar-days"
            style="display:grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border);">
            <!-- Days -->
          </div>
        </div>

        <div class="card mt-16" id="shift-details-card" style="display: none;">
          <h4 class="mb-16" id="selected-date-title"
            style="border-bottom: 1px solid var(--border); padding-bottom: 8px;"></h4>
          <div id="selected-shift-info" style="margin-bottom: 16px;">
            <!-- Shift Info -->
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="openRequestSwapModal()">
            <i class="fa-solid fa-right-left"></i> ขอแลกกะกับเพื่อน
          </button>
        </div>
      </div>

      <!-- Page: My Requests -->
      <div class="page-content" id="page-my-requests">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-envelope-open-text"></i> รายการคำขอ (ลา/OT)</h2>
          <button class="btn btn-primary" onclick="openCreateRequestModal()"><i class="fa-solid fa-plus"></i>
            สร้างคำขอใหม่</button>
        </div>

        <!-- Filter tabs -->
        <div class="request-tabs"
          style="display: flex; gap: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border);">
          <div class="req-tab active" onclick="switchReqTab('pending', this)"
            style="padding: 12px; cursor: pointer; border-bottom: 2px solid var(--primary); font-weight: bold; color: var(--primary);">
            รอดำเนินการ</div>
          <div class="req-tab" onclick="switchReqTab('history', this)"
            style="padding: 12px; cursor: pointer; color: var(--text-muted);">ประวัติคำขอ</div>
        </div>

        <div class="card p-0">
          <div id="my-requests-list" style="padding: 16px;">
            <div style="text-align:center; padding: 20px; color: var(--text-muted);"><i
                class="fa-solid fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</div>
          </div>
        </div>
      </div>

      <!-- Page: Approve Requests (OT) -->
      <div class="page-content" id="page-approve-requests">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-clock"></i> อนุมัติคำขอ OT</h2>
        </div>
        <div class="card p-0">
          <div class="table-toolbar" style="padding: 16px; border-bottom: 1px solid var(--border);">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" id="approve-ot-search" placeholder="ค้นหาชื่อพนักงาน..." class="form-control"
                oninput="filterApproveOT()" />
            </div>
            <select id="approve-ot-status" class="form-control" style="width: auto;" onchange="filterApproveOT()">
              <option value="all">ทุกสถานะ</option>
              <option value="pending" selected>รอดำเนินการ</option>
              <option value="approved">อนุมัติแล้ว</option>
              <option value="rejected">ไม่อนุมัติ</option>
            </select>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>พนักงาน</th>
                  <th>วันที่/เวลา</th>
                  <th>เหตุผล</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="approve-ot-table-body">
                <tr>
                  <td colspan="5" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Approve Leave -->
      <div class="page-content" id="page-approve-leave">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-suitcase-medical"></i> อนุมัติการลา</h2>
        </div>
        <div class="card p-0">
          <div class="table-toolbar" style="padding: 16px; border-bottom: 1px solid var(--border);">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" id="approve-leave-search" placeholder="ค้นหาชื่อพนักงาน..." class="form-control"
                oninput="filterApproveLeave()" />
            </div>
            <select id="approve-leave-status" class="form-control" style="width: auto;" onchange="filterApproveLeave()">
              <option value="all">ทุกสถานะ</option>
              <option value="pending" selected>รอดำเนินการ</option>
              <option value="approved">อนุมัติแล้ว</option>
              <option value="rejected">ไม่อนุมัติ</option>
            </select>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>พนักงาน</th>
                  <th>ประเภท/วันที่</th>
                  <th>เหตุผล/เอกสาร</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="approve-leave-table-body">
                <tr>
                  <td colspan="5" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: General Report -->
      <div class="page-content" id="page-report-general">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-file-invoice"></i> รายงานลงเวลาเข้า-ออก</h2>
          <button class="btn btn-outline" onclick="exportReport('general')"><i class="fa-solid fa-file-excel"></i>
            Export CSV</button>
        </div>
        <div class="card p-0">
          <div class="table-toolbar"
            style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 12px;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label style="font-size:12px; margin-bottom:4px;">ค้นหาพนักงาน</label>
              <input type="text" id="report-gen-search" placeholder="ชื่อ, รหัส..." class="form-control"
                oninput="filterGeneralReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">วันที่เริ่มต้น</label>
              <input type="date" id="report-gen-start" class="form-control" onchange="filterGeneralReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">วันที่สิ้นสุด</label>
              <input type="date" id="report-gen-end" class="form-control" onchange="filterGeneralReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">สาขา/หน้างาน</label>
              <select id="report-gen-wp" class="form-control" onchange="filterGeneralReport()">
                <option value="all">ทุกสาขา</option>
                <option value="สำนักงานใหญ่">สำนักงานใหญ่</option>
                <option value="สาขาเชียงใหม่">สาขาเชียงใหม่</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>วันที่</th>
                  <th>พนักงาน</th>
                  <th>สาขา/หน้างาน</th>
                  <th>เวลาเข้า</th>
                  <th>เวลาออก</th>
                  <th>สถานะ</th>
                </tr>
              </thead>
              <tbody id="report-general-table-body">
                <tr>
                  <td colspan="6" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Leave & OT Report -->
      <div class="page-content" id="page-report-leave">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-file-medical"></i> รายงานการลาและ OT</h2>
          <button class="btn btn-outline" onclick="exportReport('leave')"><i class="fa-solid fa-file-excel"></i> Export
            CSV</button>
        </div>
        <div class="card p-0">
          <div class="table-toolbar"
            style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 12px;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label style="font-size:12px; margin-bottom:4px;">ค้นหาพนักงาน</label>
              <input type="text" id="report-leave-search" placeholder="ชื่อ, รหัส..." class="form-control"
                oninput="filterLeaveReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">เดือน/ปี</label>
              <input type="month" id="report-leave-month" class="form-control" onchange="filterLeaveReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">ประเภท</label>
              <select id="report-leave-type" class="form-control" onchange="filterLeaveReport()">
                <option value="all">ทั้งหมด</option>
                <option value="leave">การลา</option>
                <option value="ot">OT</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>พนักงาน</th>
                  <th>ประเภทรายการ</th>
                  <th>รายละเอียด (ลาพักร้อน/ป่วย/โอที)</th>
                  <th>วันที่/เวลา</th>
                  <th>สถานะ (อนุมัติ)</th>
                </tr>
              </thead>
              <tbody id="report-leave-table-body">
                <tr>
                  <td colspan="5" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Audit Log -->
      <div class="page-content" id="page-audit-log">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-scroll"></i> บันทึกกิจกรรมระบบ (Audit Log)</h2>
        </div>
        <div class="card p-0">
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>วัน/เวลา</th>
                  <th>ผู้ใช้งาน</th>
                  <th>การกระทำ (Action)</th>
                  <th>รายละเอียด</th>
                  <th>IP Address</th>
                </tr>
              </thead>
              <tbody id="audit-log-table-body">
                <tr>
                  <td colspan="5" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Users -->
      <div class="page-content" id="page-users">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-users-gear"></i> จัดการผู้ใช้</h2>
          <button class="btn btn-primary" onclick="openUserModal()"><i class="fa-solid fa-plus"></i>
            เพิ่มพนักงาน</button>
        </div>
        <div class="card">
          <div class="table-toolbar">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" placeholder="ค้นหาชื่อ, รหัสพนักงาน..." class="form-control" />
            </div>
            <select class="form-control" style="width: auto;">
              <option>ทุกบทบาท</option>
              <option>HR Admin</option>
              <option>หัวหน้างาน</option>
              <option>พนักงาน</option>
            </select>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>พนักงาน</th>
                  <th>รหัส</th>
                  <th>บทบาท</th>
                  <th>สาขาหลัก</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <tr>
                  <td colspan="6" style="text-align:center; padding: 20px;">
                    <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i> กำลังโหลดข้อมูล...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Workplaces -->
      <div class="page-content" id="page-workplaces">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-building"></i> จัดการหน้างาน / สาขา</h2>
          <button class="btn btn-primary" onclick="openWorkplaceModal()"><i class="fa-solid fa-plus"></i>
            เพิ่มสาขา</button>
        </div>
        <div class="card">
          <div class="table-toolbar">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" placeholder="ค้นหาสาขา..." class="form-control" />
            </div>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>รหัส</th>
                  <th>ชื่อสาขา/หน้างาน</th>
                  <th>พิกัด (Lat, Lng)</th>
                  <th>รัศมี (ม.)</th>
                  <th>QR Code</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="workplaces-table-body">
                <tr>
                  <td colspan="7" style="text-align:center; padding: 20px;">
                    <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i> กำลังโหลดข้อมูล...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Auto-Escalation (wip) -->
      <div class="page-content" id="page-auto-escalation">
        <div class="placeholder-box">
          <h2><i class="fa-solid fa-clock-rotate-left"></i> Auto-Escalation</h2>
          <p>This module will be built in the next phases.</p>
        </div>
      </div>

      <!-- Page: Settings -->
      <div class="page-content" id="page-settings">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-sliders"></i> ตั้งค่าระบบ</h2>
          <button class="btn btn-primary"><i class="fa-solid fa-save"></i> บันทึกการตั้งค่า</button>
        </div>
        <div class="settings-grid">
          <div class="card p-24">
            <h3 class="card-title"><i class="fa-solid fa-clock"></i> กฎการเข้างาน</h3>
            <div class="form-group mb-16">
              <label>เวลาทำงานปกติ (เข้า - ออก)</label>
              <div style="display:flex; gap:12px;">
                <input type="time" class="form-control" value="09:00" />
                <span style="display:flex; align-items:center;">-</span>
                <input type="time" class="form-control" value="18:00" />
              </div>
            </div>
            <div class="form-group">
              <label>อนุโลมสายไม่เกิน (นาที)</label>
              <input type="number" class="form-control" value="15" />
            </div>
          </div>

          <div class="card p-24">
            <h3 class="card-title"><i class="fa-solid fa-shield-halved"></i> ความปลอดภัย</h3>
            <div class="form-group mb-16">
              <label>บังคับเชื่อมต่อ Wi-Fi ออฟฟิศ</label>
              <select class="form-control">
                <option>ปิด</option>
                <option>เปิด (เฉพาะจุดที่มีความเสี่ยงสูง)</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>บังคับถ่ายรูปทุกครั้งที่ลงเวลา</label>
              <select class="form-control">
                <option selected>ไม่บังคับ (เลือกใช้งานสำหรับบางไซต์)</option>
                <option>บังคับทุกไซต์งาน</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Page: Profile (wip) -->
      <div class="page-content" id="page-profile">
        <div class="placeholder-box">
          <h2><i class="fa-regular fa-user"></i> โปรไฟล์</h2>
          <p>This module will be built in the next phases.</p>
        </div>
      </div>

    </div>

    <!-- ═══════ MODALS ═══════ -->
    <!-- User Modal -->
    <div id="user-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="user-modal-title">เพิ่มพนักงาน</h3>
          <button class="btn-icon" onclick="closeModal('user-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="user-form">
            <input type="hidden" id="u-original-id">
            <div class="form-group mb-16">
              <label>รหัสพนักงาน <span class="text-danger">*</span></label>
              <input type="text" id="u-empid" class="form-control" required>
            </div>
            <div class="form-group mb-16">
              <label>ชื่อ-นามสกุล <span class="text-danger">*</span></label>
              <input type="text" id="u-name" class="form-control" required>
            </div>
            <div class="form-group mb-16">
              <label>อีเมล</label>
              <input type="email" id="u-email" class="form-control">
            </div>
            <div class="form-group mb-16">
              <label>ชื่อผู้ใช้ (Username)</label>
              <input type="text" id="u-username" class="form-control">
            </div>
            <div class="form-group mb-16">
              <label>บทบาท <span class="text-danger">*</span></label>
              <select id="u-role" class="form-control">
                <option value="พนักงาน">พนักงาน</option>
                <option value="หัวหน้างาน">หัวหน้างาน</option>
                <option value="HR Admin">HR Admin</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>สาขาหลัก (กะงาน)</label>
              <input type="text" id="u-shift" class="form-control" placeholder="สำนักงานใหญ่, สาขาเชียงใหม่...">
            </div>
            <div class="form-group mb-16">
              <label>สถานะ</label>
              <select id="u-status" class="form-control">
                <option value="ใช้งาน">ใช้งาน</option>
                <option value="ระงับ">ระงับ</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('user-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="saveUser()"><i class="fa-solid fa-save"></i> บันทึก</button>
        </div>
      </div>
    </div>

    <!-- Workplace Modal -->
    <div id="workplace-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="workplace-modal-title">เพิ่มหน้างาน / สาขา</h3>
          <button class="btn-icon" onclick="closeModal('workplace-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="workplace-form">
            <input type="hidden" id="wp-original-id">
            <div class="form-group mb-16">
              <label>รหัสสาขา/หน้างาน <span class="text-danger">*</span></label>
              <input type="text" id="wp-id" class="form-control" required placeholder="เช่น HQ001, BR002">
            </div>
            <div class="form-group mb-16">
              <label>ชื่อสาขา/หน้างาน <span class="text-danger">*</span></label>
              <input type="text" id="wp-name" class="form-control" required placeholder="สำนักงานใหญ่, ไซต์งาน A">
            </div>

            <div style="display: flex; gap: 16px; margin-bottom: 16px;">
              <div class="form-group" style="flex:1;">
                <label>Latitude <span class="text-danger">*</span></label>
                <input type="text" id="wp-lat" class="form-control" required placeholder="13.756331">
              </div>
              <div class="form-group" style="flex:1;">
                <label>Longitude <span class="text-danger">*</span></label>
                <input type="text" id="wp-lng" class="form-control" required placeholder="100.501762">
              </div>
            </div>

            <div class="form-group mb-16">
              <button type="button" class="btn btn-outline" style="width:100%; font-size: 13px;"
                onclick="getWpCurrentLocation()">
                <i class="fa-solid fa-location-crosshairs"></i> ดึงพิกัดปัจจุบัน
              </button>
            </div>

            <div class="form-group mb-16">
              <label>รัศมี (เมตร) <span class="text-danger">*</span></label>
              <input type="number" id="wp-radius" class="form-control" required value="100" min="10">
              <small class="text-muted">ระยะห่างที่อนุญาตให้พนักงานลงเวลาได้</small>
            </div>

            <div class="form-group mb-16">
              <label>สถานะ</label>
              <select id="wp-status" class="form-control">
                <option value="ใช้งาน">ใช้งาน</option>
                <option value="ระงับ">ระงับ</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('workplace-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="saveWorkplace()"><i class="fa-solid fa-save"></i> บันทึก</button>
        </div>
      </div>
    </div>

    <!-- Image View Modal -->
    <div id="image-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('image-modal')">
      <div class="modal-content" style="max-width: 600px; text-align: center;">
        <div class="modal-header">
          <h3 id="image-modal-title">รูปถ่ายยืนยันตัวตน</h3>
          <button class="btn-icon" onclick="closeModal('image-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body" style="background:#f8fafc; padding:0;">
          <img id="image-modal-img" src="" alt="Proof"
            style="width:100%; height:auto; display:block; max-height: 70vh; object-fit: contain;">
        </div>
      </div>
    </div>

    <!-- Swap Request Modal -->
    <div id="swap-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="swap-modal-title">คำขอแลกกะ</h3>
          <button class="btn-icon" onclick="closeModal('swap-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="swap-form">
            <div class="form-group mb-16">
              <label>วันที่ของคุณที่ต้องการแลก</label>
              <input type="text" id="swap-my-date" class="form-control" readonly>
              <input type="hidden" id="swap-my-date-raw">
            </div>
            <div class="form-group mb-16">
              <label>แลกกับพนักงาน <span class="text-danger">*</span></label>
              <select id="swap-target-user" class="form-control" required onchange="loadTargetUserShifts()">
                <option value="">-- เลือกพนักงาน --</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>วันที่ของพนักงานที่ต้องการแลก <span class="text-danger">*</span></label>
              <select id="swap-target-date" class="form-control" required>
                <option value="">-- กรุณาเลือกพนักงานก่อน --</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>เหตุผล</label>
              <textarea id="swap-reason" class="form-control" rows="2" placeholder="ระบุเหตุผล..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('swap-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="submitSwapRequest()"><i class="fa-solid fa-paper-plane"></i>
            ยืนยันคำขอ</button>
        </div>
      </div>
    </div>

    <!-- Pending Swap Requests Modal -->
    <div id="swap-requests-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3>รายการคำขอแลกกะ <span class="badge badge-warning" id="req-modal-badge">0</span></h3>
          <button class="btn-icon" onclick="closeModal('swap-requests-modal')"><i
              class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body" style="background:#f8fafc; padding: 16px;">
          <div id="swap-requests-list">
            <!-- pending requests -->
            <div style="text-align:center; padding: 20px; color: var(--text-muted);"><i
                class="fa-solid fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Request Modal -->
    <div id="create-request-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="create-request-modal-title">สร้างคำขอใหม่</h3>
          <button class="btn-icon" onclick="closeModal('create-request-modal')"><i
              class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="create-request-form">
            <div class="form-group mb-16">
              <label>ประเภทคำขอ <span class="text-danger">*</span></label>
              <select id="req-type" class="form-control" required onchange="toggleReqTypeFields()">
                <option value="leave">ขอลางาน</option>
                <option value="ot">ขอทำล่วงเวลา (OT)</option>
              </select>
            </div>

            <div id="leave-fields">
              <div class="form-group mb-16">
                <label>ประเภทการลา <span class="text-danger">*</span></label>
                <select id="req-leave-type" class="form-control">
                  <option value="ลาป่วย">ลาป่วย</option>
                  <option value="ลากิจ">ลากิจ</option>
                  <option value="ลาพักร้อน">ลาพักร้อน</option>
                </select>
              </div>
            </div>

            <div class="form-group mb-16">
              <label>วันที่เริ่มต้น <span class="text-danger">*</span></label>
              <input type="date" id="req-start-date" class="form-control" required>
            </div>
            <div class="form-group mb-16">
              <label>วันที่สิ้นสุด <span class="text-danger">*</span></label>
              <input type="date" id="req-end-date" class="form-control" required>
            </div>

            <div id="ot-fields" style="display:none;">
              <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                <div class="form-group" style="flex:1;">
                  <label>เวลาเริ่ม <span class="text-danger">*</span></label>
                  <input type="time" id="req-ot-start" class="form-control">
                </div>
                <div class="form-group" style="flex:1;">
                  <label>เวลาสิ้นสุด <span class="text-danger">*</span></label>
                  <input type="time" id="req-ot-end" class="form-control">
                </div>
              </div>
            </div>

            <div class="form-group mb-16">
              <label>เหตุผล / รายละเอียด <span class="text-danger">*</span></label>
              <textarea id="req-reason" class="form-control" rows="3" placeholder="ระบุรายละเอียด..."
                required></textarea>
            </div>

            <div class="form-group mb-16">
              <label>แนบไฟล์เอกสาร (ถ้ามี)</label>
              <input type="file" id="req-file" class="form-control" style="padding: 8px;">
              <small class="text-muted">เช่น ใบรับรองแพทย์ (สูงสุด 5MB)</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('create-request-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="submitMyRequest()"><i class="fa-solid fa-paper-plane"></i>
            ส่งคำขอ</button>
        </div>
      </div>
    </div>

  </main>

  <script src="script.js"></script>
</body>

</html>