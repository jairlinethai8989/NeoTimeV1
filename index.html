<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neo Work Life - ระบบจัดการเวลาเข้างาน</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- HTML2PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- Mobile Toggle -->
  <button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="fa-solid fa-bars"></i>
  </button>

  <!-- ═══ SIDEBAR ═══ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo"><i class="fa-solid fa-clock"></i></div>
      <div class="title">
        <h2>Neo Work Life</h2>
        <p>TIME ATTENDANCE</p>
      </div>
    </div>

    <nav class="sidebar-nav">
      <!-- Main links -->
      <a class="nav-item active" data-page="dashboard" onclick="navigateTo('dashboard', this)">
        <div class="nav-item-content"><i class="fa-solid fa-house"></i> <span>Dashboard</span></div>
      </a>

      <a class="nav-item" data-page="checkin" onclick="navigateTo('checkin', this)">
        <div class="nav-item-content"><i class="fa-solid fa-location-dot"></i> <span>เช็คอิน/เช็คเอาท์</span></div>
      </a>

      <a class="nav-item" data-page="records" onclick="navigateTo('records', this)">
        <div class="nav-item-content"><i class="fa-solid fa-list-check"></i> <span>บันทึกการเข้างาน</span></div>
      </a>

      <a class="nav-item" data-page="map" onclick="navigateTo('map', this)">
        <div class="nav-item-content"><i class="fa-solid fa-map"></i> <span>แผนที่</span></div>
      </a>

      <a class="nav-item" data-page="worklog" onclick="navigateTo('worklog', this)">
        <div class="nav-item-content"><i class="fa-solid fa-file-pen"></i> <span>บันทึกการทำงาน</span></div>
      </a>

      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-solid fa-calendar-days"></i> <span>ตารางกะงาน</span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="shifts" onclick="navigateTo('shifts', this, true)">ดูตารางกะงาน</a>
          <a class="nav-child" data-page="manage-shifts" onclick="navigateTo('manage-shifts', this, true)">จัดตารางกะงาน</a>
        </div>
      </div>
      <!-- Groups / Dropdowns -->
      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-solid fa-envelope-open-text"></i> <span>คำขอของฉัน</span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="my-requests" onclick="navigateTo('my-requests', this, true)">รายการคำขอ</a>
        </div>
      </div>

      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-regular fa-circle-check"></i> <span>อนุมัติ <span id="nav-badge-approve-total" class="badge badge-danger" style="display:none; padding:2px 6px; font-size:10px; margin-left: 6px;">0</span></span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="approve-requests"
            onclick="navigateTo('approve-requests', this, true)">อนุมัติคำขอ <span id="nav-badge-approve-ot" class="badge badge-danger" style="display:none; padding:2px 6px; font-size:10px; margin-left: auto;">0</span></a>
          <a class="nav-child" data-page="approve-leave"
            onclick="navigateTo('approve-leave', this, true)">อนุมัติการลา <span id="nav-badge-approve-leave" class="badge badge-danger" style="display:none; padding:2px 6px; font-size:10px; margin-left: auto;">0</span></a>
        </div>
      </div>

      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-regular fa-file-lines"></i> <span>รายงาน</span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="report-general"
            onclick="navigateTo('report-general', this, true)">รายงานทั่วไป</a>
          <a class="nav-child" data-page="report-leave" onclick="navigateTo('report-leave', this, true)">รายงานการลา</a>
          <a class="nav-child" data-page="audit-log" onclick="navigateTo('audit-log', this, true)">Audit Log</a>
        </div>
      </div>

      <div class="nav-group">
        <a class="nav-item nav-has-child" onclick="toggleNavGroup(this)">
          <div class="nav-item-content"><i class="fa-solid fa-gear"></i> <span>จัดการระบบ</span></div>
          <i class="fa-solid fa-chevron-down nav-arrow"></i>
        </a>
        <div class="nav-children">
          <a class="nav-child" data-page="users" onclick="navigateTo('users', this, true)">จัดการผู้ใช้</a>
          <a class="nav-child" data-page="workplaces" onclick="navigateTo('workplaces', this, true)">จัดการหน้างาน</a>
          <a class="nav-child" data-page="settings" onclick="navigateTo('settings', this, true)">ตั้งค่าระบบ</a>
        </div>
      </div>

      <a class="nav-item" data-page="profile" onclick="navigateTo('profile', this)">
        <div class="nav-item-content"><i class="fa-regular fa-user"></i> <span>โปรไฟล์</span></div>
      </a>
    </nav>

    <div class="sidebar-footer">
      <a class="nav-item btn-logout" onclick="logout()">
        <div class="nav-item-content"><i class="fa-solid fa-right-from-bracket"></i> <span>ออกจากระบบ</span></div>
      </a>
    </div>
  </aside>

  <!-- ═══ MAIN CONTENT ═══ -->
  <main class="main-wrapper">
    <!-- Top Header -->
    <header class="top-header">
      <div class="header-title">
        <h1 id="page-title">Dashboard</h1>
        <p id="header-date">วันเสาร์ที่ 21 กุมภาพันธ์ 2569</p>
      </div>

      <div class="header-actions">
        <div class="status-indicator hide-mobile">
          <div class="status-dot"></div> <span style="color:#10b981">ออนไลน์</span>
        </div>

        <button class="icon-btn hide-mobile" onclick="refreshPageData()" title="รีเฟรช">
          <i class="fa-solid fa-arrows-rotate"></i>
        </button>

        <div class="header-user">
          <div class="header-user-info hide-mobile">
            <h4 id="user-display-name">HR Administrator</h4>
            <p id="user-display-role">HR Admin</p>
          </div>
          <div class="user-avatar">
            <img src="https://ui-avatars.com/api/?name=HR+Admin&background=2563eb&color=fff" alt="User"
              id="user-avatar-img">
          </div>
        </div>
      </div>
    </header>

    <!-- ═══════ PAGES CONTAINER ═══════ -->
    <div class="pages-container">

      <!-- Page: Dashboard -->
      <div class="page-content active" id="page-dashboard">
        <!-- Stat Cards -->
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-icon bg-primary-light text-primary"><i class="fa-solid fa-users"></i></div>
            <div class="stat-info">
              <h3>พนักงานทั้งหมด</h3>
              <div class="stat-val" id="dash-total">120</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-success-light text-success"><i class="fa-solid fa-user-check"></i></div>
            <div class="stat-info">
              <h3>มาทำงานวันนี้</h3>
              <div class="stat-val" id="dash-present">95</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-warning-light text-warning"><i class="fa-solid fa-clock"></i></div>
            <div class="stat-info">
              <h3>มาสาย</h3>
              <div class="stat-val" id="dash-late">12</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-danger-light text-danger"><i class="fa-solid fa-user-xmark"></i></div>
            <div class="stat-info">
              <h3>ขาดงาน</h3>
              <div class="stat-val" id="dash-absent">13</div>
            </div>
          </div>
        </div>

        <!-- Secondary Stat Grid: Leaves -->
        <div class="stat-grid" style="margin-top: 16px;">
          <div class="stat-card">
            <div class="stat-icon bg-info-light text-info"><i class="fa-solid fa-file-contract"></i></div>
            <div class="stat-info">
              <h3>ลางานรวม</h3>
              <div class="stat-val" id="dash-leave-total">12</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-warning-light text-warning"><i class="fa-solid fa-briefcase"></i></div>
            <div class="stat-info">
              <h3>ลากิจ</h3>
              <div class="stat-val" id="dash-leave-personal">5</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-danger-light text-danger"><i class="fa-solid fa-bed"></i></div>
            <div class="stat-info">
              <h3>ลาป่วย</h3>
              <div class="stat-val" id="dash-leave-sick">3</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-primary-light text-primary"><i class="fa-solid fa-umbrella-beach"></i></div>
            <div class="stat-info">
              <h3>ลาพักร้อน</h3>
              <div class="stat-val" id="dash-leave-vacation">4</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon bg-success-light text-success"><i class="fa-solid fa-truck-fast"></i></div>
            <div class="stat-info">
              <h3>ทำงานนอกพื้นที่</h3>
              <div class="stat-val" id="dash-offsite">18</div>
            </div>
          </div>
        </div>

        <!-- Dashboard: Leave Calendar (Full Width) -->
        <div class="dashboard-card" style="margin-bottom: 24px;">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
              <h3 class="card-title"><i class="fa-solid fa-calendar-check"></i> ปฏิทินการลาประจำเดือน</h3>
              <div style="display:flex; align-items:center; gap:8px;">
                <button class="btn-icon" onclick="changeDashLeaveMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="dash-leave-month-label" style="font-weight:600; font-size:15px;">-</span>
                <button class="btn-icon" onclick="changeDashLeaveMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
              </div>
            </div>
            <div class="card-body" style="padding: 16px 20px;">
              <div style="display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                <div style="color:#FF3B30;">อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div style="color:#007AFF;">ส</div>
              </div>
              <div id="dash-leave-calendar" style="display:grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                <!-- Rendered by JS -->
              </div>
              <div style="display:flex; gap:20px; margin-top:16px; font-size:12px; color:var(--text-muted); flex-wrap:wrap; padding-top:12px; border-top: 1px solid var(--border);">
                <div><span style="display:inline-block;width:10px;height:10px;border-radius:4px;background:#FF3B30;vertical-align:middle;margin-right:6px;"></span>ลาป่วย</div>
                <div><span style="display:inline-block;width:10px;height:10px;border-radius:4px;background:#FF9500;vertical-align:middle;margin-right:6px;"></span>ลากิจ</div>
                <div><span style="display:inline-block;width:10px;height:10px;border-radius:4px;background:#007AFF;vertical-align:middle;margin-right:6px;"></span>ลาพักร้อน</div>
              </div>
            </div>
        </div>

        <!-- Dashboard: Mini Map -->
        <div class="dashboard-card">
            <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-map-location-dot"></i> การกระจายตัวหน้างาน (Mini Map)</h3>
            </div>
            <div class="card-body" style="padding:0; position: relative; overflow: hidden; border-bottom-left-radius: var(--radius-lg); border-bottom-right-radius: var(--radius-lg);">
               <div id="dash-mini-map" style="width: 100%; height: 260px; z-index: 1;"></div>
               <div style="position: absolute; bottom: 12px; right: 12px; z-index: 2;">
                 <button class="btn btn-primary" style="padding: 6px 12px; font-size: 13px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="navigateTo('map', document.querySelector('[data-page=map]'))"><i class="fa-solid fa-maximize"></i> ขยายแผนที่หลัก</button>
               </div>
            </div>
        </div>
      </div>

      <!-- Page: Check-in / Check-out -->
      <div class="page-content" id="page-checkin">
        <div class="checkin-container">
          <!-- Time Display -->
          <div class="checkin-time-display">
            <div class="time-label">เวลาปัจจุบัน</div>
            <div class="time-value" id="ci-clock">00:00</div>
            <div class="date-value" id="ci-date">วัน...</div>
          </div>

          <!-- Status Card -->
          <div class="checkin-status empty">
            <div class="status-icon"><i class="fa-solid fa-location-dot"></i></div>
            <h3>ระบบลงเวลาอิสระ</h3>
            <p>คุณสามารถลงเวลาเข้า-ออกงานได้จากทุกที่</p>
          </div>

          <!-- Attendance Type -->
          <div class="checkin-card" style="margin-bottom: 24px; padding: 16px; border: 2px solid var(--border);" id="ci-type-card">
            <h4 style="margin-bottom: 12px; font-size: 14px; text-align: center;"><i class="fa-solid fa-clipboard-list text-primary"></i> เลือกประเภทการลงเวลา</h4>
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: bold; font-size: 15px;">
                    <input type="radio" name="ci-type" value="เวลาปกติ" checked onchange="updateCheckinColors('normal')">
                    <span style="color: var(--primary);">เวลาปกติ</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: bold; font-size: 15px;">
                    <input type="radio" name="ci-type" value="OT" onchange="updateCheckinColors('ot')">
                    <span style="color: var(--warning);">OT</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: bold; font-size: 15px;">
                    <input type="radio" name="ci-type" value="เข้ากะ" onchange="updateCheckinColors('shift')">
                    <span style="color: var(--info);">เข้ากะ</span>
                </label>
            </div>
          </div>

          <!-- Location Info -->
          <div class="checkin-card" style="margin-bottom: 24px;">
            <h3 class="card-title"><i class="fa-solid fa-location-crosshairs"></i> ข้อมูลพิกัดปัจจุบัน</h3>

            <div class="gps-status-box" id="ci-gps-box" style="margin-bottom:0;">
              <div class="gps-icon"><i class="fa-solid fa-spinner fa-spin"></i></div>
              <div class="gps-info">
                <h4>กำลังค้นหาตำแหน่ง...</h4>
                <p id="ci-coords">โปรดรอสักครู่</p>
              </div>
              <button class="icon-btn-small" onclick="initGeo()" title="รีเฟรชตำแหน่ง"><i
                  class="fa-solid fa-arrows-rotate"></i></button>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="checkin-actions" style="margin-bottom: 24px;">
            <button class="btn btn-primary btn-checkin" id="btn-ci" onclick="submitCheckin('Check-in')" style="padding: 16px; font-size: 18px; border-radius: 12px; transition: all 0.3s; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
              <i class="fa-solid fa-right-to-bracket"></i> เช็คอิน (เข้างาน)
            </button>
            <button class="btn btn-outline btn-checkout" id="btn-co" onclick="submitCheckin('Check-out')" style="padding: 16px; font-size: 18px; border-radius: 12px; transition: all 0.3s;">
              <i class="fa-solid fa-right-from-bracket"></i> เช็คเอาท์ (ออกงาน)
            </button>
          </div>

          <!-- Identity & Note -->
          <div class="checkin-card">
            <h3 class="card-title"><i class="fa-regular fa-id-badge"></i> ข้อมูลเพิ่มเติม</h3>
            <div class="info-row" style="margin-bottom: 16px;">
              <div class="info-label">พนักงาน</div>
              <div class="info-value"><strong id="ci-emp-name">กำลังโหลด...</strong> <span id="ci-emp-id"></span></div>
            </div>
            
            <div class="form-group">
              <label>หมายเหตุ (ถ้ามี)</label>
              <textarea class="form-control" id="ci-note" rows="2" placeholder="ระบุรายละเอียดเพิ่มเติม..."></textarea>
            </div>
          </div>

        </div>
      </div>

      <!-- Page: Records -->
      <div class="page-content" id="page-records">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-list-check"></i> บันทึกการเข้างาน</h2>
          <button class="btn btn-outline" onclick="loadRecords()"><i class="fa-solid fa-arrows-rotate"></i>
            รีเฟรช</button>
        </div>

        <div class="card">
          <div class="table-toolbar">
            <div class="search-box">
              <i class="fa-solid fa-calendar-day"></i>
              <input type="date" id="records-date-filter" class="form-control" onchange="loadRecords()" />
            </div>
            <div class="search-box" style="margin-left: 12px;">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" id="records-search" class="form-control" placeholder="ค้นหาชื่อ, รหัส..."
                oninput="filterRecordsTable()" />
            </div>
          </div>

          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>วันที่-เวลา</th>
                  <th>พนักงาน</th>
                  <th>ประเภท</th>
                  <th>สถานะ</th>
                  <th>สาขา/พิกัด</th>
                  <th>ระยะห่าง</th>
                  <th>หมายเหตุ/รูปถ่าย</th>
                </tr>
              </thead>
              <tbody id="records-table-body">
                <tr>
                  <td colspan="7" style="text-align:center; padding: 20px;">
                    <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i> กำลังโหลดข้อมูล...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Map -->
      <div class="page-content" id="page-map">
        <div style="display: flex; flex-direction: column; height: calc(100vh - var(--header-h) - 48px);">
            <div class="management-header" style="margin-bottom: 16px;">
              <h2 class="page-title"><i class="fa-solid fa-map-location-dot"></i> แผนที่และการกระจายตัว</h2>
              <button class="btn btn-outline" onclick="loadMap()"><i class="fa-solid fa-arrows-rotate"></i> รีเฟรชพิกัด</button>
            </div>
            <div class="card p-0" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; border-radius: var(--radius-lg); box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
              <div id="main-leaflet-map" style="width: 100%; height: 100%; z-index: 1;"></div>
            </div>
        </div>
      </div>

      <!-- Page: Shifts -->
      <div class="page-content" id="page-shifts">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-calendar-days"></i> ตารางกะงาน</h2>
          <button class="btn btn-outline" onclick="openSwapRequestsModal()">
            <i class="fa-solid fa-bell"></i> คำขอแลกกะ <span id="swap-req-badge" class="badge badge-danger"
              style="display:none; padding: 2px 6px; font-size: 10px;">0</span>
          </button>
        </div>

        <div class="card p-0" style="overflow: hidden;">
          <div class="calendar-toolbar"
            style="display:flex; justify-content:space-between; align-items:center; padding: 16px; border-bottom: 1px solid var(--border);">
            <button class="btn-icon" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
            <h3 id="current-month-year" style="margin:0; font-size:16px;">-</h3>
            <button class="btn-icon" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
          </div>
          <div class="calendar-weekdays"
            style="display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; padding: 8px 0; background: var(--bg-body); font-size: 12px; font-weight: bold; color: var(--text-muted);">
            <div>อา</div>
            <div>จ</div>
            <div>อ</div>
            <div>พ</div>
            <div>พฤ</div>
            <div>ศ</div>
            <div>ส</div>
          </div>
          <div id="calendar-days"
            style="display:grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border);">
            <!-- Days -->
          </div>
        </div>

        <div class="card mt-16" id="shift-details-card" style="display: none;">
          <h4 class="mb-16" id="selected-date-title"
            style="border-bottom: 1px solid var(--border); padding-bottom: 8px;"></h4>
          <div id="selected-shift-info" style="margin-bottom: 16px;">
            <!-- Shift Info -->
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="openRequestSwapModal()">
            <i class="fa-solid fa-right-left"></i> ขอแลกกะกับเพื่อน
          </button>
        </div>
      </div>

      <!-- Page: Manage Shifts -->
      <div class="page-content" id="page-manage-shifts">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-calendar-plus"></i> จัดตารางกะงาน (Manual & AI)</h2>
          <div>
            <button class="btn btn-outline" onclick="addEmployeeToShiftTable()"><i class="fa-solid fa-user-plus"></i> เลือกพนักงานลงตาราง</button>
            <button class="btn btn-primary" style="margin-left: 8px;" onclick="generateAIShifts()"><i class="fa-solid fa-wand-magic-sparkles"></i> AI จัดกะให้อัตโนมัติ</button>
          </div>
        </div>
        
        <div class="card p-0" style="margin-bottom: 24px;">
            <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                <h3 style="margin: 0; font-size: 16px; color: var(--text-color);"><i class="fa-solid fa-sliders"></i> เงื่อนไขในการจัดกะ</h3>
                <button class="btn btn-outline" style="padding: 4px 12px; font-size: 13px;" onclick="addShiftCondition()">
                    <i class="fa-solid fa-plus"></i> เพิ่มเงื่อนไข
                </button>
            </div>
            <div id="shift-conditions-list" style="padding: 16px; display: flex; flex-direction: column; gap: 12px;">
                <!-- Condition Items -->
                <div class="condition-item" style="display: flex; gap: 12px; align-items: center; background: white; padding: 12px; border: 1px solid var(--border); border-radius: 6px;">
                    <label class="switch">
                        <input type="checkbox" checked>
                        <span class="slider round"></span>
                    </label>
                    <select class="form-control" style="width: auto; flex: 1;">
                        <option value="dept">แผนก (Department)</option>
                        <option value="emp" selected>ชื่อพนักงาน</option>
                        <option value="shift_req">กะที่ต้องเข้า</option>
                        <option value="max_consecutive">จำนวนกะติดต่อกันสูงสุด</option>
                    </select>
                    <input type="text" class="form-control" style="flex: 2;" placeholder="ระบุเงื่อนไข เช่น ต้องมีเข้ากะเช้าอย่างน้อย 1 คน">
                    <button class="btn-icon text-danger" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>

        <div class="card p-0" style="overflow: hidden;">
          <div class="calendar-toolbar"
            style="display:flex; justify-content:space-between; align-items:center; padding: 16px; border-bottom: 1px solid var(--border);">
            <button class="btn-icon" onclick="changeManageMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
            <h3 id="manage-month-year" style="margin:0; font-size:16px;">-</h3>
            <button class="btn-icon" onclick="changeManageMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
          </div>
          
          <div class="table-responsive" id="manage-shifts-table-container">
             <!-- Scheduled shift table to be rendered by JS -->
             <div style="text-align:center; padding: 40px; color: var(--text-muted);">
                 <i class="fa-solid fa-calendar-days" style="font-size: 48px; margin-bottom: 16px; color: #cbd5e1;"></i>
                 <p>กดปุ่ม "จัดตารางด้วย AI" เพื่อสร้างตารางกะงานของเดือนนี้</p>
             </div>
          </div>
        </div>
      </div>


      <!-- Page: My Requests -->
      <div class="page-content" id="page-my-requests">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-envelope-open-text"></i> รายการคำขอ (ลา/OT)</h2>
          <button class="btn btn-primary" onclick="openCreateRequestModal()"><i class="fa-solid fa-plus"></i>
            สร้างคำขอใหม่</button>
        </div>

        <!-- Filter tabs -->
        <div class="request-tabs"
          style="display: flex; gap: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border);">
          <div class="req-tab active" onclick="switchReqTab('pending', this)"
            style="padding: 12px; cursor: pointer; border-bottom: 2px solid var(--primary); font-weight: bold; color: var(--primary);">
            รอดำเนินการ</div>
          <div class="req-tab" onclick="switchReqTab('history', this)"
            style="padding: 12px; cursor: pointer; color: var(--text-muted);">ประวัติคำขอ</div>
        </div>

        <div class="card p-0">
          <div id="my-requests-list" style="padding: 16px;">
            <div style="text-align:center; padding: 20px; color: var(--text-muted);"><i
                class="fa-solid fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</div>
          </div>
        </div>
      </div>

      <!-- Page: Approve Requests (OT) -->
      <div class="page-content" id="page-approve-requests">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-clock"></i> อนุมัติคำขอ OT</h2>
        </div>
        <div class="card p-0">
          <div class="table-toolbar" style="padding: 16px; border-bottom: 1px solid var(--border);">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" id="approve-ot-search" placeholder="ค้นหาชื่อพนักงาน..." class="form-control"
                oninput="filterApproveOT()" />
            </div>
            <select id="approve-ot-status" class="form-control" style="width: auto;" onchange="filterApproveOT()">
              <option value="all">ทุกสถานะ</option>
              <option value="pending" selected>รอดำเนินการ</option>
              <option value="approved">อนุมัติแล้ว</option>
              <option value="rejected">ไม่อนุมัติ</option>
            </select>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>พนักงาน</th>
                  <th>วันที่/เวลา</th>
                  <th>เหตุผล</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="approve-ot-table-body">
                <tr>
                  <td colspan="5" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Approve Leave -->
      <div class="page-content" id="page-approve-leave">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-suitcase-medical"></i> อนุมัติการลา</h2>
        </div>
        <div class="card p-0">
          <div class="table-toolbar" style="padding: 16px; border-bottom: 1px solid var(--border);">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" id="approve-leave-search" placeholder="ค้นหาชื่อพนักงาน..." class="form-control"
                oninput="filterApproveLeave()" />
            </div>
            <select id="approve-leave-status" class="form-control" style="width: auto;" onchange="filterApproveLeave()">
              <option value="all">ทุกสถานะ</option>
              <option value="pending" selected>รอดำเนินการ</option>
              <option value="approved">อนุมัติแล้ว</option>
              <option value="rejected">ไม่อนุมัติ</option>
            </select>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>พนักงาน</th>
                  <th>ประเภท/วันที่</th>
                  <th>เหตุผล/เอกสาร</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="approve-leave-table-body">
                <tr>
                  <td colspan="5" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: General Report -->
      <div class="page-content" id="page-report-general">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-file-invoice"></i> รายงานลงเวลาเข้า-ออก</h2>
          <button class="btn btn-outline" onclick="exportReport('general')"><i class="fa-solid fa-file-excel"></i>
            Export CSV</button>
        </div>
        <div class="card p-0">
          <div class="table-toolbar"
            style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 12px;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label style="font-size:12px; margin-bottom:4px;">ค้นหาพนักงาน</label>
              <input type="text" id="report-gen-search" placeholder="ชื่อ, รหัส..." class="form-control"
                oninput="filterGeneralReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">วันที่เริ่มต้น</label>
              <input type="date" id="report-gen-start" class="form-control" onchange="filterGeneralReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">วันที่สิ้นสุด</label>
              <input type="date" id="report-gen-end" class="form-control" onchange="filterGeneralReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">สาขา/หน้างาน</label>
              <select id="report-gen-wp" class="form-control" onchange="filterGeneralReport()">
                <option value="all">ทุกสาขา</option>
                <option value="สำนักงานใหญ่">สำนักงานใหญ่</option>
                <option value="สาขาเชียงใหม่">สาขาเชียงใหม่</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>วันที่</th>
                  <th>พนักงาน</th>
                  <th>สาขา/หน้างาน</th>
                  <th>เวลาเข้า</th>
                  <th>เวลาออก</th>
                  <th>สถานะ</th>
                </tr>
              </thead>
              <tbody id="report-general-table-body">
                <tr>
                  <td colspan="6" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Leave & OT Report -->
      <div class="page-content" id="page-report-leave">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-file-medical"></i> รายงานการลาและ OT</h2>
          <button class="btn btn-outline" onclick="exportReport('leave')"><i class="fa-solid fa-file-excel"></i> Export
            CSV</button>
        </div>
        <div class="card p-0">
          <div class="table-toolbar"
            style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 12px;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label style="font-size:12px; margin-bottom:4px;">ค้นหาพนักงาน</label>
              <input type="text" id="report-leave-search" placeholder="ชื่อ, รหัส..." class="form-control"
                oninput="filterLeaveReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">เดือน/ปี</label>
              <input type="month" id="report-leave-month" class="form-control" onchange="filterLeaveReport()" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label style="font-size:12px; margin-bottom:4px;">ประเภท</label>
              <select id="report-leave-type" class="form-control" onchange="filterLeaveReport()">
                <option value="all">ทั้งหมด</option>
                <option value="leave">การลา</option>
                <option value="ot">OT</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>พนักงาน</th>
                  <th>ประเภทรายการ</th>
                  <th>รายละเอียด (ลาพักร้อน/ป่วย/โอที)</th>
                  <th>วันที่/เวลา</th>
                  <th>สถานะ (อนุมัติ)</th>
                </tr>
              </thead>
              <tbody id="report-leave-table-body">
                <tr>
                  <td colspan="5" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Audit Log -->
      <div class="page-content" id="page-audit-log">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-scroll"></i> บันทึกกิจกรรมระบบ (Audit Log)</h2>
        </div>
        <div class="card p-0">
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>วัน/เวลา</th>
                  <th>ผู้ใช้งาน</th>
                  <th>การกระทำ (Action)</th>
                  <th>รายละเอียด</th>
                  <th>IP Address</th>
                </tr>
              </thead>
              <tbody id="audit-log-table-body">
                <tr>
                  <td colspan="5" style="text-align:center; padding: 20px;"><i class="fa-solid fa-spinner fa-spin"></i>
                    กำลังโหลดข้อมูล...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Users -->
      <div class="page-content" id="page-users">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-users-gear"></i> จัดการผู้ใช้</h2>
          <button class="btn btn-primary" onclick="openUserModal()"><i class="fa-solid fa-plus"></i>
            เพิ่มพนักงาน</button>
        </div>
        <div class="card">
          <div class="table-toolbar">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" placeholder="ค้นหาชื่อ, รหัสพนักงาน..." class="form-control" />
            </div>
            <select class="form-control" style="width: auto;">
              <option>ทุกบทบาท</option>
              <option>HR Admin</option>
              <option>หัวหน้างาน</option>
              <option>พนักงาน</option>
            </select>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>พนักงาน</th>
                  <th>รหัส</th>
                  <th>บทบาท</th>
                  <th>สาขาหลัก</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <tr>
                  <td colspan="6" style="text-align:center; padding: 20px;">
                    <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i> กำลังโหลดข้อมูล...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Page: Workplaces -->
      <div class="page-content" id="page-workplaces">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-building"></i> จัดการหน้างาน / สาขา</h2>
          <button class="btn btn-primary" onclick="openWorkplaceModal()"><i class="fa-solid fa-plus"></i>
            เพิ่มสาขา</button>
        </div>
        <div class="card">
          <div class="table-toolbar">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text" placeholder="ค้นหาสาขา..." class="form-control" />
            </div>
          </div>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>รหัส</th>
                  <th>ชื่อสาขา/หน้างาน</th>
                  <th>พิกัด (Lat, Lng)</th>
                  <th>รัศมี (ม.)</th>
                  <th>QR Code</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="workplaces-table-body">
                <tr>
                  <td colspan="7" style="text-align:center; padding: 20px;">
                    <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i> กำลังโหลดข้อมูล...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

        </div>
      </div>

      <!-- Page: Settings -->
      <div class="page-content" id="page-settings">
        <div class="management-header">
          <h2 class="page-title"><i class="fa-solid fa-sliders"></i> ตั้งค่าระบบ</h2>
          <button class="btn btn-primary" onclick="saveSystemSettings()"><i class="fa-solid fa-save"></i> บันทึกการตั้งค่า</button>
        </div>
        <div class="settings-grid">
          <div class="card p-24">
            <h3 class="card-title"><i class="fa-solid fa-clock"></i> กฎการเข้างาน</h3>
            <div class="form-group mb-16">
              <label>เวลาทำงานปกติ (เข้า - ออก)</label>
              <div style="display:flex; gap:12px;">
                <input type="text" class="form-control" id="st-time-in" value="09:00" placeholder="HH:mm" maxlength="5" pattern="[0-2][0-9]:[0-5][0-9]" />
                <span style="display:flex; align-items:center;">-</span>
                <input type="text" class="form-control" id="st-time-out" value="18:00" placeholder="HH:mm" maxlength="5" pattern="[0-2][0-9]:[0-5][0-9]" />
              </div>
            </div>
            <div class="form-group">
              <label>อนุโลมสายไม่เกิน (นาที)</label>
              <input type="number" class="form-control" id="st-late-grace" value="15" />
            </div>
          </div>

          <div class="card p-24">
            <h3 class="card-title"><i class="fa-solid fa-shield-halved"></i> ความปลอดภัย</h3>
            <div class="form-group mb-16">
              <label>บังคับเชื่อมต่อ Wi-Fi ออฟฟิศ</label>
              <select class="form-control" id="st-wifi">
                <option value="off">ปิด</option>
                <option value="on">เปิด (เฉพาะจุดที่มีความเสี่ยงสูง)</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>บังคับถ่ายรูปทุกครั้งที่ลงเวลา</label>
              <select class="form-control" id="st-photo">
                <option value="optional" selected>ไม่บังคับ (เลือกใช้งานสำหรับบางไซต์)</option>
                <option value="always">บังคับทุกไซต์งาน</option>
              </select>
            </div>
            
            <h3 class="card-title" style="margin-top: 24px;"><i class="fa-solid fa-calendar-check"></i> สิทธิ์วันลาต่อปี</h3>
            <div style="display: flex; gap: 12px; margin-bottom: 8px;">
              <div class="form-group" style="flex:1;">
                <label>ลาป่วย (วัน)</label>
                <input type="number" class="form-control" id="st-leave-sick" value="30" min="0">
              </div>
              <div class="form-group" style="flex:1;">
                <label>ลากิจ (วัน)</label>
                <input type="number" class="form-control" id="st-leave-personal" value="6" min="0">
              </div>
              <div class="form-group" style="flex:1;">
                <label>ลาพักร้อน (วัน)</label>
                <input type="number" class="form-control" id="st-leave-vacation" value="6" min="0">
              </div>
            </div>
            <div style="display: flex; gap: 12px; margin-bottom: 8px;">
              <div class="form-group" style="flex:1;">
                <label>ห้ามลาต่อเนื่องเกิน (วัน)</label>
                <input type="number" class="form-control" id="st-leave-max-consecutive" value="3" min="1" placeholder="เช่น 3 หมายถึงห้ามลาเกิน 3 วันติดต่อกัน">
                <small class="text-muted">กำหนดจำนวนวันสูงสุดที่พนักงานสามารถลาติดต่อกันได้</small>
              </div>
            </div>
          
          <div class="card p-24">
            <h3 class="card-title"><i class="fa-solid fa-building-user"></i> ตั้งค่าองค์กร</h3>
            <div class="form-group mb-16">
              <label>แผนก / ฝ่าย</label>
              <div id="dept-tags-container" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; min-height:36px; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: white;">
                <!-- Department tags rendered by JS -->
              </div>
              <div style="display:flex; gap:8px;">
                <input type="text" id="dept-new-input" class="form-control" placeholder="พิมพ์ชื่อแผนกใหม่..." style="flex:1;">
                <button class="btn btn-primary" type="button" onclick="addDepartmentTag()" style="padding: 8px 16px;"><i class="fa-solid fa-plus"></i> เพิ่มแผนก</button>
              </div>
              <input type="hidden" id="st-departments">
            </div>
          </div>
          
          <div class="card p-24" style="grid-column: 1 / -1;">
            <h3 class="card-title"><i class="fa-solid fa-palette"></i> ธีม & โลโก้</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">
                <div class="form-group">
                  <label>ธีมของระบบ (Theme)</label>
                  <select id="st-theme-mode" class="form-control" onchange="previewThemeMode(this.value)">
                    <option value="light">สว่าง (Light Mode)</option>
                    <option value="dark">มืด (Dark Mode)</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>โลโก้โปรแกรม (Sidebar / Header)</label>
                  <input type="file" id="st-logo-upload" class="form-control" accept="image/*" onchange="previewSettingsImage(this, 'st-logo-preview')">
                  <img id="st-logo-preview" src="" style="max-height: 48px; margin-top: 8px; display: none; object-fit: contain;">
                  <button class="btn btn-outline text-danger mt-8" style="padding: 4px 12px; font-size: 11px;" onclick="clearSettingsImage('st-logo')">ลบรูปโลโก้</button>
                </div>
                
                <div class="form-group">
                  <label>รูปลายน้ำ (Watermark สำหรับเอกสารต่างๆ)</label>
                  <input type="file" id="st-watermark-upload" class="form-control" accept="image/*" onchange="previewSettingsImage(this, 'st-watermark-preview')">
                  <img id="st-watermark-preview" src="" style="max-height: 80px; margin-top: 8px; display: none; object-fit: contain; opacity: 0.5;">
                  <button class="btn btn-outline text-danger mt-8" style="padding: 4px 12px; font-size: 11px;" onclick="clearSettingsImage('st-watermark')">ลบรูปลายน้ำ</button>
                </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page: Worklog -->
      <div class="page-content" id="page-worklog">
        <div class="management-header" style="margin-bottom: 16px;">
          <h2 class="page-title"><i class="fa-solid fa-file-pen"></i> บันทึกการทำงานประจำวัน (Timesheet)</h2>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-outline" onclick="exportWorklog()"><i class="fa-solid fa-file-export"></i> Export CSV</button>
            <button class="btn btn-outline" onclick="sendWorklogMonthly()"><i class="fa-solid fa-paper-plane"></i> ส่งรายงานประจำเดือน</button>
            <button class="btn btn-primary" onclick="saveWorklogDraft()"><i class="fa-solid fa-save"></i> Save Draft & Submit</button>
          </div>
        </div>

        <div class="card" style="padding: 20px;">
            <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h3 class="card-title" style="margin: 0;"><i class="fa-solid fa-clipboard-list"></i> ข้อมูลบันทึกการทำงาน</h3>
                    <select id="wl-view-mode" class="form-control" style="width: 140px;" onchange="changeWorklogView()">
                        <option value="daily">แสดงประจำวัน</option>
                        <option value="weekly">แสดงประจำสัปดาห์</option>
                        <option value="monthly">แสดงประจำเดือน</option>
                    </select>
                </div>
                <!-- Controls for navigating periods -->
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="btn-icon" onclick="changeWorklogPeriod(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="wl-current-date" style="font-weight: 600;">...</span>
                    <button class="btn-icon" onclick="changeWorklogPeriod(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    <button class="btn btn-outline" style="margin-left: 12px;" onclick="addWorklogEntry()"><i class="fa-solid fa-plus"></i> เพิ่มรายการงาน</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table wl-table-styled" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 120px; vertical-align: middle;" class="wl-col-date">วันที่</th>
                            <th style="width: 200px; vertical-align: middle;">เวลาเริ่ม - เวลาสิ้นสุด</th>
                            <th style="vertical-align: middle;">รายละเอียดการทำงาน / โปรเจกต์ <span class="text-danger">*</span></th>
                            <th style="width: 140px; vertical-align: middle;">สถานะงาน</th>
                            <th style="width: 80px; vertical-align: middle; text-align: center;">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="worklog-tbody">
                        <!-- Entries added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
      </div>

      <!-- Page: Profile -->
      <div class="page-content" id="page-profile">
        <div class="management-header" style="margin-bottom: 24px;">
          <h2 class="page-title"><i class="fa-regular fa-user"></i> โปรไฟล์ของฉัน</h2>
        </div>

        <div class="profile-container" style="max-width: 800px; margin: 0 auto; display: grid; gap: 24px;">
          
          <!-- Profile Header Card -->
          <div class="card p-24" style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
            <div class="profile-avatar" style="position: relative;">
              <input type="file" id="profile-upload" hidden accept="image/*" onchange="previewProfileImage(this)">
              <img src="https://ui-avatars.com/api/?name=User&background=2563eb&color=fff" id="profile-img-preview" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--surface); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <button type="button" class="btn-icon" style="position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; width: 32px; height: 32px;" title="เปลี่ยนรูปโปรไฟล์" onclick="document.getElementById('profile-upload').click()"><i class="fa-solid fa-camera"></i></button>
            </div>
            <div class="profile-title-info" style="flex: 1;">
              <h3 id="profile-display-name" style="font-size: 24px; margin-bottom: 4px;">กำลังโหลด...</h3>
              <p id="profile-display-role" class="text-muted" style="margin-bottom: 8px;">-</p>
              <span id="profile-display-status" class="badge badge-success">ใช้งาน</span>
            </div>
          </div>

          <!-- Edit Form Card -->
          <div class="card p-24">
            <h4 style="margin-bottom: 20px; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px;"><i class="fa-solid fa-address-card" style="color: var(--primary);"></i> ข้อมูลส่วนตัว</h4>
            
            <form id="profile-form" onsubmit="event.preventDefault(); saveProfileData();">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                
                <div class="form-group">
                  <label>รหัสพนักงาน (ไม่สามารถแก้ไขได้)</label>
                  <input type="text" id="prof-empid" class="form-control" disabled style="background-color: var(--bg-main);">
                </div>

                <div class="form-group">
                  <label>ชื่อ-นามสกุล <span class="text-danger">*</span></label>
                  <input type="text" id="prof-name" class="form-control" required>
                </div>

                <div class="form-group">
                  <label>อีเมล</label>
                  <input type="email" id="prof-email" class="form-control">
                </div>

                <div class="form-group">
                  <label>บทบาท (ไม่สามารถแก้ไขได้)</label>
                  <input type="text" id="prof-role" class="form-control" disabled style="background-color: var(--bg-main);">
                </div>

                <div class="form-group">
                  <label>เบอร์โทรศัพท์ติดต่อ</label>
                  <input type="tel" id="prof-phone" class="form-control" placeholder="08X-XXX-XXXX">
                </div>

                <div class="form-group">
                  <label>แผนก / ฝ่าย</label>
                  <input type="text" id="prof-department" class="form-control" placeholder="เช่น ไอที, ฝ่ายขาย">
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1; margin-top: 12px;">
                  <label>ลายเซ็นอิเล็กทรอนิกส์</label>
                  <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: start; background: var(--bg-main); padding: 16px; border-radius: 8px;">
                     <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px; background: white; border: 1px dashed var(--border); border-radius: 8px; position: relative;">
                      <img id="saved-signature-preview" src="" style="max-width: 100%; max-height: 80px; display: none;" alt="Saved Signature">
                      <p id="no-signature-text" class="text-muted" style="font-size: 13px; margin: 0 0 12px 0;">ยังไม่มีลายเซ็นในระบบ</p>
                      <button type="button" class="btn btn-outline" style="z-index: 10;" onclick="openSignatureModal()"><i class="fa-solid fa-pen-nib"></i> จัดการลายเซ็นของฉัน</button>
                    </div>
                  </div>
                  <input type="hidden" id="prof-signature_base64">
                </div>

              </div>
              
              <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid var(--border); padding-top: 16px;">
                <button type="button" class="btn btn-outline" onclick="loadProfileData()"><i class="fa-solid fa-rotate-left"></i> รีเซ็ต</button>
                <button type="submit" class="btn btn-primary" id="btn-save-profile"><i class="fa-solid fa-floppy-disk"></i> บันทึกข้อมูล</button>
              </div>
            </form>
          </div>

          <!-- Password Reset Card -->
          <div class="card p-24">
            <h4 style="margin-bottom: 20px; font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px;"><i class="fa-solid fa-lock" style="color: var(--warning);"></i> ความปลอดภัย</h4>
            <p class="text-muted" style="font-size: 13px; margin-bottom: 16px;">หากต้องการเปลี่ยนรหัสผ่าน กรุณากดปุ่มด้านล่าง ระบบจะส่งลิงก์สำหรับรีเซ็ตรหัสผ่านไปยังอีเมลของคุณ</p>
            <button class="btn btn-outline" onclick="requestPasswordReset()"><i class="fa-solid fa-envelope"></i> ส่งลิงก์รีเซ็ตรหัสผ่าน</button>
          </div>

        </div>
      </div>

    </div>

    <!-- ═══════ MODALS ═══════ -->
    <!-- User Modal -->
    <div id="user-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="user-modal-title">เพิ่มพนักงาน</h3>
          <button class="btn-icon" onclick="closeModal('user-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="user-form">
            <input type="hidden" id="u-original-id">
            <div class="form-group mb-16">
              <label>รหัสพนักงาน <span class="text-danger">*</span></label>
              <input type="text" id="u-empid" class="form-control" required>
            </div>
            <div class="form-group mb-16">
              <label>ชื่อ-นามสกุล <span class="text-danger">*</span></label>
              <input type="text" id="u-name" class="form-control" required>
            </div>
            <div class="form-group mb-16">
              <label>อีเมล</label>
              <input type="email" id="u-email" class="form-control">
            </div>
            <div class="form-group mb-16">
              <label>ชื่อผู้ใช้ (Username)</label>
              <input type="text" id="u-username" class="form-control">
            </div>
            <div class="form-group mb-16">
              <label>บทบาท <span class="text-danger">*</span></label>
              <select id="u-role" class="form-control">
                <option value="พนักงาน">พนักงาน</option>
                <option value="หัวหน้างาน">หัวหน้างาน</option>
                <option value="HR Admin">HR Admin</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>แผนก/ฝ่าย</label>
              <select id="u-department" class="form-control">
                <option value="">-- เลือกแผนก --</option>
                <option value="ไอที">ไอที</option>
                <option value="บัญชี">บัญชี</option>
                <option value="ฝ่ายขาย">ฝ่ายขาย</option>
                <option value="ฝ่ายบุคคล">ฝ่ายบุคคล</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>สาขาหลัก (กะงาน)</label>
              <input type="text" id="u-shift" class="form-control" placeholder="สำนักงานใหญ่, สาขาเชียงใหม่...">
            </div>
            <div class="form-group mb-16">
              <label>สถานะ</label>
              <select id="u-status" class="form-control">
                <option value="ใช้งาน">ใช้งาน</option>
                <option value="ระงับ">ระงับ</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>สิทธิ์การเข้าถึงเมนู</label>
              <div class="permissions-list" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); padding: 8px; border-radius: 6px; background: white; font-size: 13px;">
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="dashboard" checked> Dashboard</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="checkin" checked> เช็คอิน/เช็คเอาท์</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="records" checked> บันทึกการเข้างาน</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="map" checked> แผนที่</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="worklog" checked> บันทึกการทำงาน</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="shifts" checked> ดูตารางกะงาน</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="manage-shifts"> จัดตารางกะงาน</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="my-requests" checked> รายการคำขอ</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="approve-requests"> อนุมัติคำขอ</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="approve-leave"> อนุมัติการลา</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="report-general"> รายงานทั่วไป</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="report-leave"> รายงานการลา</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="audit-log"> Audit Log</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="users"> จัดการผู้ใช้</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="workplaces"> จัดการหน้างาน</label>
                <label style="display:block; margin-bottom: 4px;"><input type="checkbox" name="u-perms" value="settings"> ตั้งค่าระบบ</label>
              </div>
            </div>
            <div class="form-group mb-16">
              <label><i class="fa-solid fa-calendar-check"></i> สิทธิ์การลา (เฉพาะพนักงานคนนี้)</label>
              <div style="display:flex; gap:12px; flex-wrap:wrap; border: 1px solid var(--border); padding: 10px; border-radius: 6px; background: white;">
                <div class="form-group" style="flex:1; min-width:100px;">
                  <label style="font-size:11px;">ลาป่วย (วัน)</label>
                  <input type="number" class="form-control" id="u-leave-sick" value="" min="0" placeholder="ตามค่าเริ่มต้น">
                </div>
                <div class="form-group" style="flex:1; min-width:100px;">
                  <label style="font-size:11px;">ลากิจ (วัน)</label>
                  <input type="number" class="form-control" id="u-leave-personal" value="" min="0" placeholder="ตามค่าเริ่มต้น">
                </div>
                <div class="form-group" style="flex:1; min-width:100px;">
                  <label style="font-size:11px;">ลาพักร้อน (วัน)</label>
                  <input type="number" class="form-control" id="u-leave-vacation" value="" min="0" placeholder="ตามค่าเริ่มต้น">
                </div>
              </div>
              <small class="text-muted">หากเว้นว่าง จะใช้ค่าเริ่มต้นจากตั้งค่าระบบแทน</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('user-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="saveUser()"><i class="fa-solid fa-save"></i> บันทึก</button>
        </div>
      </div>
    </div>

    <!-- Workplace Modal -->
    <div id="workplace-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="workplace-modal-title">เพิ่มหน้างาน / สาขา</h3>
          <button class="btn-icon" onclick="closeModal('workplace-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="workplace-form">
            <input type="hidden" id="wp-original-id">
            <div class="form-group mb-16">
              <label>รหัสสาขา/หน้างาน <span class="text-danger">*</span></label>
              <input type="text" id="wp-id" class="form-control" required placeholder="เช่น HQ001, BR002">
            </div>
            <div class="form-group mb-16">
              <label>ชื่อสาขา/หน้างาน <span class="text-danger">*</span></label>
              <input type="text" id="wp-name" class="form-control" required placeholder="สำนักงานใหญ่, ไซต์งาน A">
            </div>

            <div style="display: flex; gap: 16px; margin-bottom: 16px;">
              <div class="form-group" style="flex:1;">
                <label>Latitude <span class="text-danger">*</span></label>
                <input type="text" id="wp-lat" class="form-control" required placeholder="13.756331">
              </div>
              <div class="form-group" style="flex:1;">
                <label>Longitude <span class="text-danger">*</span></label>
                <input type="text" id="wp-lng" class="form-control" required placeholder="100.501762">
              </div>
            </div>

            <div class="form-group mb-16">
              <button type="button" class="btn btn-outline" style="width:100%; font-size: 13px;"
                onclick="getWpCurrentLocation()">
                <i class="fa-solid fa-location-crosshairs"></i> ดึงพิกัดปัจจุบัน
              </button>
            </div>

            <div class="form-group mb-16">
              <label>รัศมี (เมตร) <span class="text-danger">*</span></label>
              <input type="number" id="wp-radius" class="form-control" required value="100" min="10">
              <small class="text-muted">ระยะห่างที่อนุญาตให้พนักงานลงเวลาได้</small>
            </div>

            <div class="form-group mb-16">
              <label>สถานะ</label>
              <select id="wp-status" class="form-control">
                <option value="ใช้งาน">ใช้งาน</option>
                <option value="ระงับ">ระงับ</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('workplace-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="saveWorkplace()"><i class="fa-solid fa-save"></i> บันทึก</button>
        </div>
      </div>
    </div>

    <!-- Image View Modal -->
    <div id="image-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('image-modal')">
      <div class="modal-content" style="max-width: 600px; text-align: center;">
        <div class="modal-header">
          <h3 id="image-modal-title">รูปถ่ายยืนยันตัวตน</h3>
          <button class="btn-icon" onclick="closeModal('image-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body" style="background:#f8fafc; padding:0;">
          <img id="image-modal-img" src="" alt="Proof"
            style="width:100%; height:auto; display:block; max-height: 70vh; object-fit: contain;">
        </div>
      </div>
    </div>

    <!-- Swap Request Modal -->
    <div id="swap-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="swap-modal-title">คำขอแลกกะ</h3>
          <button class="btn-icon" onclick="closeModal('swap-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="swap-form">
            <div class="form-group mb-16">
              <label>วันที่ของคุณที่ต้องการแลก</label>
              <input type="text" id="swap-my-date" class="form-control" readonly>
              <input type="hidden" id="swap-my-date-raw">
            </div>
            <div class="form-group mb-16">
              <label>แลกกับพนักงาน <span class="text-danger">*</span></label>
              <select id="swap-target-user" class="form-control" required onchange="loadTargetUserShifts()">
                <option value="">-- เลือกพนักงาน --</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>วันที่ของพนักงานที่ต้องการแลก <span class="text-danger">*</span></label>
              <select id="swap-target-date" class="form-control" required>
                <option value="">-- กรุณาเลือกพนักงานก่อน --</option>
              </select>
            </div>
            <div class="form-group mb-16">
              <label>เหตุผล</label>
              <textarea id="swap-reason" class="form-control" rows="2" placeholder="ระบุเหตุผล..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('swap-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="submitSwapRequest()"><i class="fa-solid fa-paper-plane"></i>
            ยืนยันคำขอ</button>
        </div>
      </div>
    </div>

    <!-- Pending Swap Requests Modal -->
    <div id="swap-requests-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3>รายการคำขอแลกกะ <span class="badge badge-warning" id="req-modal-badge">0</span></h3>
          <button class="btn-icon" onclick="closeModal('swap-requests-modal')"><i
              class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body" style="background:#f8fafc; padding: 16px;">
          <div id="swap-requests-list">
            <!-- pending requests -->
            <div style="text-align:center; padding: 20px; color: var(--text-muted);"><i
                class="fa-solid fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Request Modal -->
    <div id="create-request-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="create-request-modal-title">สร้างคำขอใหม่</h3>
          <button class="btn-icon" onclick="closeModal('create-request-modal')"><i
              class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <form id="create-request-form">
            <div class="form-group mb-16">
              <label>ประเภทคำขอ <span class="text-danger">*</span></label>
              <select id="req-type" class="form-control" required onchange="toggleReqTypeFields()">
                <option value="leave">ขอลางาน</option>
                <option value="ot">ขอทำล่วงเวลา (OT)</option>
              </select>
            </div>

            <div id="leave-fields">
              <div class="form-group mb-16">
                <label>ประเภทการลา <span class="text-danger">*</span></label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <select id="req-leave-type" class="form-control" style="flex: 2; min-width: 120px;" onchange="updateLeaveRemainingBalance()">
                    <option value="ลาป่วย">ลาป่วย</option>
                    <option value="ลากิจ">ลากิจ</option>
                    <option value="ลาพักร้อน">ลาพักร้อน</option>
                  </select>
                  <select id="req-leave-duration" class="form-control" style="flex: 1; min-width: 140px;" onchange="updateLeaveDatesLogic()">
                    <option value="full">เต็มวัน</option>
                    <option value="morning">ครึ่งวัน (เช้า)</option>
                    <option value="afternoon">ครึ่งวัน (บ่าย)</option>
                  </select>
                </div>
                <small id="leave-balance-display" class="text-primary mt-2" style="display: block; margin-top: 6px;">สิทธิ์คงเหลือ: - วัน</small>
              </div>
            </div>

            <div class="form-group mb-16" id="leave-date-start-group">
              <label>วันที่เริ่มต้น <span class="text-danger">*</span></label>
              <input type="date" id="req-start-date" class="form-control" required onchange="calculateLeaveDays()">
            </div>
            <div class="form-group mb-16" id="leave-date-end-group">
              <label>วันที่สิ้นสุด <span class="text-danger">*</span></label>
              <input type="date" id="req-end-date" class="form-control" required onchange="calculateLeaveDays()">
            </div>
            
            <div class="form-group mb-16" id="leave-total-days-group" style="display: none; background: #eff6ff; padding: 12px; border-radius: 6px; border: 1px dashed var(--primary);">
                <label style="color: var(--primary); font-weight: bold; margin-bottom: 0;">รวมจำนวนวันลา: <span id="leave-total-days-value">1</span> วัน</label>
            </div>

            <div id="ot-fields" style="display:none;">
              <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                <div class="form-group" style="flex:1;">
                  <label>เวลาเริ่ม <span class="text-danger">*</span></label>
                  <input type="time" id="req-ot-start" class="form-control">
                </div>
                <div class="form-group" style="flex:1;">
                  <label>เวลาสิ้นสุด <span class="text-danger">*</span></label>
                  <input type="time" id="req-ot-end" class="form-control">
                </div>
              </div>
            </div>

            <div class="form-group mb-16">
              <label>เหตุผล / รายละเอียด <span class="text-danger">*</span></label>
              <textarea id="req-reason" class="form-control" rows="3" placeholder="ระบุรายละเอียด..."
                required></textarea>
            </div>

            <div class="form-group mb-16">
              <label>แนบไฟล์เอกสาร (ถ้ามี)</label>
              <input type="file" id="req-file" class="form-control" style="padding: 8px;">
              <small class="text-muted">เช่น ใบรับรองแพทย์ (สูงสุด 5MB)</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('create-request-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="submitMyRequest()"><i class="fa-solid fa-paper-plane"></i>
            ส่งคำขอ</button>
        </div>
      </div>
    </div>

    <!-- View Document Modal for PDF Export -->
    <div id="view-doc-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h3 id="view-doc-modal-title">ใบคำขอ / เอกสาร</h3>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-primary" onclick="exportDocToPDF()"><i class="fa-solid fa-file-pdf"></i> ดาวน์โหลด PDF</button>
            <button class="btn-icon" onclick="closeModal('view-doc-modal')"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div class="modal-body" style="background: #e2e8f0; padding: 24px; max-height: 70vh; overflow-y: auto;">
          <!-- A4 Paper Container -->
          <div id="pdf-export-container" style="background: white; padding: 40px; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: 'Noto Sans Thai', sans-serif; color: black; margin: 0 auto; width: 100%; max-width: 210mm; min-height: 297mm; position: relative; box-sizing: border-box;">
            
            <div style="text-align: center; margin-bottom: 30px;">
               <div style="font-size: 28px; color: var(--primary); margin-bottom: 8px;"><i class="fa-solid fa-mountain-sun"></i></div>
              <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 4px;" id="doc-type-title">ใบคำขอลางาน (Leave Request Form)</h2>
              <p style="font-size: 14px; color: #555;">บริษัท นีโอ เน็ตเวิร์ค จำกัด</p>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 13px;">
              <div><strong>รหัสเอกสาร:</strong> <span id="doc-req-id">-</span></div>
              <div><strong>วันที่ยื่นคำขอ:</strong> <span id="doc-req-date">-</span></div>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 13px;">
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd; width: 30%; background: #f8fafc;"><strong>ชื่อพนักงาน:</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;" id="doc-emp-name">-</td>
              </tr>
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd; background: #f8fafc;"><strong>รายการ/ประเภท:</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;" id="doc-req-type">-</td>
              </tr>
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd; background: #f8fafc;"><strong>รายละเอียด/เหตุผล:</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;" id="doc-req-reason">-</td>
              </tr>
              <tr>
                <td style="padding: 10px; border: 1px solid #ddd; background: #f8fafc;"><strong>ระยะเวลา/วันที่:</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd;" id="doc-req-duration">-</td>
              </tr>
            </table>

            <div style="margin-top: 60px; display: flex; justify-content: space-around;">
              
              <div style="text-align: center; width: 220px;">
                <div style="height: 100px; display: flex; align-items: end; justify-content: center; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 8px;">
                  <img id="doc-requester-sign" src="" style="max-width: 100%; max-height: 80px; display: none;">
                  <span id="doc-requester-no-sign" style="color: #999; font-size: 12px; font-style: italic;">(ไม่มีลายเซ็น ลายมือชื่ออิเล็กทรอนิกส์)</span>
                </div>
                <p style="margin: 0; font-size: 14px; font-weight: bold;" id="doc-requester-name">ลงชื่อ................................</p>
                <p style="margin: 4px 0 0; font-size: 12px; color: #666;">ผู้ยื่นคำขอ</p>
              </div>

              <div style="text-align: center; width: 220px;">
                <div style="height: 100px; display: flex; align-items: end; justify-content: center; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 8px;">
                  <img id="doc-approver-sign" src="" style="max-width: 100%; max-height: 80px; display: none;">
                  <span id="doc-approver-no-sign" style="color: #999; font-size: 12px; font-style: italic;">(ไม่มีลายเซ็น ลายมือชื่ออิเล็กทรอนิกส์)</span>
                </div>
                <p style="margin: 0; font-size: 14px; font-weight: bold;" id="doc-approver-name">ลงชื่อ................................</p>
                <p style="margin: 4px 0 0; font-size: 12px; color: #666;">ผู้อนุมัติ</p>
                <p style="margin: 4px 0 0; font-size: 11px; color: #666;">สถานะ: <strong id="doc-approval-status">-</strong></p>
              </div>

            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Signature Modal -->
    <div id="signature-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3 id="signature-modal-title"><i class="fa-solid fa-pen-nib"></i> จัดการลายเซ็นอิเล็กทรอนิกส์</h3>
          <button class="btn-icon" onclick="closeModal('signature-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
            <p class="text-muted" style="font-size: 13px; margin-bottom: 12px;">วาดลายเซ็นของคุณลงในกรอบด้านล่าง หรืออัปโหลดภาพลายเซ็น (พื้นหลังโปร่งใสแนะนำ)</p>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                <strong>วาดลายเซ็น</strong>
                <button type="button" class="btn-icon" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #ddd; border-radius: 4px;" onclick="clearSignature()"><i class="fa-solid fa-eraser"></i> ล้างลายเซ็น</button>
            </div>
            
            <div style="border: 2px dashed var(--border); border-radius: var(--radius-sm); background: #f8fafc; overflow: hidden; height: 250px; position: relative; margin-bottom: 16px;">
              <canvas id="signature-canvas" width="600" height="250" style="width: 100%; height: 100%; touch-action: none; cursor: crosshair;"></canvas>
            </div>
            
            <div class="form-group" style="border-top: 1px solid var(--border); padding-top: 16px;">
               <label>หรือแนบไฟล์รูปภาพลายเซ็น</label>
               <input type="file" id="signature-file-upload" class="form-control" accept="image/*" onchange="importSignatureFile(this)">
            </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between;">
           <span class="text-muted" style="font-size: 11px; align-self: center;">*ลายเซ็นนี้จะอัปเดตลงในโปรไฟล์ของคุณ</span>
           <div>
            <button class="btn btn-outline" onclick="closeModal('signature-modal')">ยกเลิก</button>
            <button class="btn btn-primary" onclick="confirmSignatureModal()"><i class="fa-solid fa-save"></i> นำไปใช้</button>
           </div>
        </div>
      </div>
    </div>

    <!-- Modal: Employee Picker for Shift Scheduling -->
    <div class="modal-overlay" id="shift-emp-picker-modal">
      <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
          <h3><i class="fa-solid fa-user-check"></i> เลือกพนักงานลงตารางกะ</h3>
          <button class="btn-icon" onclick="closeModal('shift-emp-picker-modal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
          <div style="margin-bottom: 12px;">
            <input type="text" class="form-control" id="shift-emp-search" placeholder="ค้นหาชื่อพนักงาน..." oninput="filterShiftEmpPicker()">
          </div>
          <div id="shift-emp-checkbox-list" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- Checkboxes rendered by JS -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('shift-emp-picker-modal')">ยกเลิก</button>
          <button class="btn btn-primary" onclick="confirmShiftEmpPicker()"><i class="fa-solid fa-check"></i> เพิ่มพนักงานที่เลือก</button>
        </div>
      </div>
    </div>

  </main>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Main Script -->
  <script src="script.js" charset="utf-8"></script>
</body>

</html>